# Intual API

Intual's main product. Handles:

- User information
- Project creation & deletion
- File uploads & processing (chunking + embedding)

Tech Stack:

- Router: `labstack/echo`
- Codegen: `sqlc`
- Migrations: `golang-migrate`

## Developing Locally

`brew install golang-migrate sqlc`

### Step 1: Code Generation

The API relies on autogenerated Go code for database models. This is so we don't have to constantly update our own models to reflect the database schema. The `migrations/` folder is the single source of truth for the database, and everything works around it.

The mock script in `../scripts/mock.py` handles the following responsibilities:

1. Initialize all databases
2. Apply migrations
3. Generate Go data models

The way it works is interesting. `sqlc` parses the schemas from all our migrations (generated with `golang-migrate`) and generates some data models. **However**, you also write your queries in SQL. Other ORMs & codegen tools don't handle join tables very well (many-to-many relationships), but this lets us properly model things like users -> projects by writing the SQL ourselves.

It also lets us have type safety on our code and everything is synced with our DB state, so we don't have to manually update our Golang models.

- `gen`: Gitignored, stores all models and code (see [routes/projects.go](routes/projects.go)) for an example
- `queries`: All queries our data model supports

Run `sqlc generate` to regenerate models in case the schema changes

**Generated code is not committed**.

### Step 2: Environment Variables

- `POSTGRES_DSN`: Complete Postgres connection string
- `CLERK_API_KEY`: Clerk API key for authentication

## Authentication & Testing Locally

The API uses clerk's golang SDK to validate and retrieve user information from a session token. Every request should send the `Authentication: Bearer {token}` header. The API will use the token to retrieve the current user's information.

[Clerk Golang documentation](https://clerk.com/docs/backend-requests/handling/go)

**We backdoored the middleware boys** ðŸ¦€

If you set the bearer token to `test-key`, the middleware will authenticate you as test user `user_2jRfvOhhMBfHM5C85C1q3Ze1Ron` (user: `intual`, pass: `intual`, email: `intual@example.com`). This will let you develop the API headlessly (without a browser).

## Endpoints

### User Endpoint

`POST /user`: Insert a new user into the database

- No parameters (except bearer token)
- Must happen first

### Projects Endpoint

#### Generic Endpoints

`GET /projects`: Gets a list of all projects this user has access to

`POST /projects`: Create a new project (with this user as the owner)

Body:

```json
{
  "project_name": "...",
  "description": "...",
  "industry": "...",
  "use_case": "...",
  "model_type": "...",
  "function": "..."
}
```

Returns:

`Project`

#### {project_id} Endpoints

`GET /projects/{project_id}`: Returns project data structure

`PATCH /projects/{project_id}`: Update project **(partial update w/ gopartial)**

`DELETE /projects/{project_id}`: Deletes a project

> Ideally each file should have permissions with who's allowed to access it, but we're not trying to be Dropbox / Google Drive, so I think this can be ignored.

> Should we support directories? Each project is a folder inside the intual-projects bucket for all the user's files. I think this can also be ignored for now.

<hr />

### Files Endpoint

**Note:** Since the API is the main product, the API should be the one handling file uploads right? The dashboard just invokes it.

| Method   | Action                                           | Description                                                |
| -------- | ------------------------------------------------ | ---------------------------------------------------------- |
| `GET`    | `/projects/{project_id}/files`                   | List all files associated with the project                 |
| `POST`   | `/projects/{project_id}/files`                   | Upload a new file (directly upload to bucket), returns key |
| `POST`   | `/projects/{project_id}/files/{file_id}/process` | Process a file (chunk & embed)                             |
| `DELETE` | `/projects/{project_id}/files/{file_id}`         | Delete a file (& embeddings)                               |
